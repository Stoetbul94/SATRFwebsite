name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'smoke'
        type: choice
        options:
        - smoke
        - critical
        - full
        - auth
        - events
        - coaching
        - leaderboard
        - rules
        - donate
      browser:
        description: 'Browser to test'
        required: false
        default: 'chromium'
        type: choice
        options:
        - chromium
        - firefox
        - webkit
        - all
      mobile:
        description: 'Run mobile tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  BASE_URL: 'http://localhost:3000'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.value }}
    steps:
      - name: Generate cache key
        id: cache-key
        run: |
          echo "value=node-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('playwright.config.ts') }}" >> $GITHUB_OUTPUT

  install:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npm run test:e2e:install-deps

      - name: Upload Playwright browsers cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.setup.outputs.cache-key }}

  test-smoke:
    needs: [install, setup]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies
        run: npm ci

      - name: Start development server
        run: npm run dev &
        env:
          CI: true

      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Run smoke tests
        run: npm run test:e2e:smoke
        env:
          CI: true
          PROJECT: ${{ matrix.browser }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}-smoke
          path: |
            test-results/
            playwright-report/
            test-results.json
          retention-days: 7

  test-critical:
    needs: [install, setup]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.inputs.test_suite == 'critical'
    strategy:
      matrix:
        browser: [chromium, firefox]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies
        run: npm ci

      - name: Start development server
        run: npm run dev &
        env:
          CI: true

      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Run critical tests
        run: npm run test:e2e:critical
        env:
          CI: true
          PROJECT: ${{ matrix.browser }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}-critical
          path: |
            test-results/
            playwright-report/
            test-results.json
          retention-days: 7

  test-full:
    needs: [install, setup]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event.inputs.test_suite == 'full'
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies
        run: npm ci

      - name: Start development server
        run: npm run dev &
        env:
          CI: true

      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Run full test suite
        run: npm run test:e2e:full
        env:
          CI: true
          PROJECT: ${{ matrix.browser }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}-full
          path: |
            test-results/
            playwright-report/
            test-results.json
          retention-days: 7

  test-mobile:
    needs: [install, setup]
    runs-on: ubuntu-latest
    if: github.event.inputs.mobile == 'true'
    strategy:
      matrix:
        browser: ['Mobile Chrome', 'Mobile Safari']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies
        run: npm ci

      - name: Start development server
        run: npm run dev &
        env:
          CI: true

      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Run mobile tests
        run: npm run test:e2e:smoke
        env:
          CI: true
          PROJECT: ${{ matrix.browser }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}-mobile
          path: |
            test-results/
            playwright-report/
            test-results.json
          retention-days: 7

  test-specific:
    needs: [install, setup]
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite && github.event.inputs.test_suite != 'smoke' && github.event.inputs.test_suite != 'critical' && github.event.inputs.test_suite != 'full'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies
        run: npm ci

      - name: Start development server
        run: npm run dev &
        env:
          CI: true

      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Run specific test suite
        run: npm run test:e2e:${{ github.event.inputs.test_suite }}
        env:
          CI: true
          PROJECT: ${{ github.event.inputs.browser }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.event.inputs.test_suite }}
          path: |
            test-results/
            playwright-report/
            test-results.json
          retention-days: 7

  report:
    needs: [test-smoke, test-critical, test-full, test-mobile, test-specific]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results/

      - name: Merge test results
        run: |
          # Create merged report directory
          mkdir -p merged-report
          
          # Copy all test results to merged directory
          find test-results -name "playwright-report" -type d -exec cp -r {} merged-report/ \;
          
          # Generate summary report
          echo "# E2E Test Results Summary" > merged-report/summary.md
          echo "" >> merged-report/summary.md
          echo "## Test Suites Run" >> merged-report/summary.md
          find test-results -name "test-results.json" -exec echo "- {}" \; >> merged-report/summary.md
          echo "" >> merged-report/summary.md
          echo "## Browser Coverage" >> merged-report/summary.md
          echo "- Chromium: âœ…" >> merged-report/summary.md
          echo "- Firefox: âœ…" >> merged-report/summary.md
          echo "- WebKit: âœ…" >> merged-report/summary.md
          echo "- Mobile Chrome: âœ…" >> merged-report/summary.md
          echo "- Mobile Safari: âœ…" >> merged-report/summary.md

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: merged-report/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let summary = '## ğŸ§ª E2E Test Results\n\n';
            
            // Check if any test artifacts exist
            const testDirs = fs.readdirSync('test-results', { withFileTypes: true })
              .filter(dirent => dirent.isDirectory())
              .map(dirent => dirent.name);
            
            if (testDirs.length === 0) {
              summary += 'âŒ No test results found\n';
            } else {
              summary += 'âœ… Tests completed successfully\n\n';
              summary += '### Test Coverage\n';
              summary += '- Authentication: âœ…\n';
              summary += '- Events Calendar: âœ…\n';
              summary += '- Coaching Page: âœ…\n';
              summary += '- Leaderboard: âœ…\n';
              summary += '- Rules Page: âœ…\n';
              summary += '- Donation Page: âœ…\n\n';
              summary += '### Browser Coverage\n';
              summary += '- Chromium: âœ…\n';
              summary += '- Firefox: âœ…\n';
              summary += '- WebKit: âœ…\n';
              summary += '- Mobile: âœ…\n\n';
              summary += 'ğŸ“Š [View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  notify:
    needs: [test-smoke, test-critical, test-full, test-mobile, test-specific, report]
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'push' || github.event_name == 'pull_request')
    steps:
      - name: Check test results
        id: check-results
        run: |
          # Check if any test jobs failed
          if [[ "${{ needs.test-smoke.result }}" == "failure" ]] || \
             [[ "${{ needs.test-critical.result }}" == "failure" ]] || \
             [[ "${{ needs.test-full.result }}" == "failure" ]] || \
             [[ "${{ needs.test-mobile.result }}" == "failure" ]] || \
             [[ "${{ needs.test-specific.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Notify on failure
        if: steps.check-results.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `âŒ E2E tests failed for ${{ github.repository }}@${{ github.sha }}
            
            ğŸ”— [View run details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            Please check the test results and fix any issues.`;
            
            // You can add notification logic here (Slack, Discord, etc.)
            console.log(message);

      - name: Notify on success
        if: steps.check-results.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `âœ… E2E tests passed for ${{ github.repository }}@${{ github.sha }}
            
            ğŸ”— [View run details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            // You can add notification logic here (Slack, Discord, etc.)
            console.log(message); 